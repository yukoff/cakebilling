[[CakeBaseInstall <<](.md) ] [[CakeBaseInstall <](.md) ] [[CakeToc В начало](.md) ] [[CakeInstallHowto >](.md) ] [[InstallPostgresToc >>](.md) ]



#### Состав системы ####

Система состоит из нескольких независимых модулей:

  * **pptpd** - менеджер VPN соединений. Обеспечивает первоначальное подключение и запуск pppd.
  * **pppd** - транспортный инкапсулятор туннелей. Обеспечивает инкапсуляцию PPP в IP протокол.
  * **FreeRADIUS** - RADIUS сервер. Обеспечивает AAA (Authorization, Authentication, and Accounting).
  * **PostgreSQL** - сервер СУБД. Обеспечивает хранение аккаунтов, информации о траффике, содержит необходимую бизнес-логику для учёта потребляемого траффика и ограничения доступа в интернет.

#### Механизм соединения ####

  1. На стороне клиента создаем VPN подключение.
  1. Далее при попытке подключения клиента к серверу **pptpd** создает **GRE туннель** и передает поток из него **pppd**.
  1. **pppd** запрашивает авторизацию у **RADIUS сервера**.
  1. **RADIUS сервер** обращается к **СУБД** и на основе полученных данных формирует ответ.
  1. **pppd** получает ответ от **RADIUS сервера**, разрешающий или запрещающий подключение.
  1. Про получении разрешающего ответа, **pppd** устанавливает различные лимиты ( по времени или допустимому объему трафика) на сессию, если необходимые атрибуты содержались в ответе.
  1. После этого **pppd** отправляет **RADIUS серверу** пакет с уведомлением о старте сессии.
  1. Далее **pppd** может отправлять данные о промежуточном состоянии сессии, если в  ответе от **RADIUS сервера** был установлен необходимый атрибут.
  1. Сессия завершается при разрыве соединения **пользователем** или **pppd** при превышении установленных лимитов.
  1. После закрытия сессии **pppd** отсылает **RADIUS серверу** пакет о завершении сессии.

#### Порядок обмена пакетами (в терминах RADIUS протокола) ####


| **шаг** | **пакет** | **цель** | **-** | **цель** | **атрибуты** | **примечания** |
|:--------|:----------|:---------|:------|:---------|:-------------|:---------------|
| **_авторизация_** |           |          |       |          |              |                |
| 1       | auth-request | pppd     | >     | radius   | username, userpassword | запрос на существоание юзера в базе|
| 2       | auth-accept/auth-reject | pppd     | <     | radius   | yes or no    | есть/нет       |
| **_получение reply пакета/отлуп_** |           |          |       |          |              |                |
| 3       | auth-reply | pppd     | <     | radius   | traffic limit, time limit | ответ          |
| **_работа на линии_** |           |          |       |          |              |                |
| 5       | acct-start | pppd     | >     | radius   | current datetime, username, session id | старт сессии   |
| 6       | acct-alive | pppd     | >     | radius   | current datetime, session id, traffic | обновление данных сессии |
| ...     | acct-alive | ppd      | >     | radius   | ...          | повторение с заданным периодом |
| 7       | acct-stop | pppd     | >     | radius   | current datetime, traffic | стоп сессии    |
| **_отлуп_** |           |          |       |          |              |                |

[[CakeBaseInstall <<](.md) ] [[CakeBaseInstall <](.md) ] [[CakeToc В начало](.md) ] [[CakeInstallHowto >](.md) ] [[InstallPostgresToc  >>](.md) ]